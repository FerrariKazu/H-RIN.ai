# Multi-Candidate Comparative AI Analysis - PASS 1 + PASS 2

## ‚úÖ IMPLEMENTATION COMPLETE

### PASS 1: Per-Candidate Individual Analysis
**Status:** ‚úÖ Complete

For each uploaded CV:
- Candidate profile (name, seniority, domain)
- Experience summary
- Skills (technical + soft)
- Entities (certifications, tools, companies, roles)
- AI Executive Assessment (single-candidate)
- Preliminary AI fit score (0‚Äì100)
- Recommended roles (generated by Qwen2.5)

**Storage:** Per document_id

**Output:** Stored in `documents[].analysis.llm_analysis`

---

### PASS 2: Cross-Candidate Comparative Analysis
**Status:** ‚úÖ Complete

After PASS 1 completes for all CVs, a single comparative LLM call receives:
- All candidate profiles
- All extracted skills/entities
- Job requirements
- Preliminary scores

**The LLM must:**
- ‚úÖ Compare candidates against each other (NOT in isolation)
- ‚úÖ Normalize AI fit scores across candidates
- ‚úÖ Rank candidates from best fit ‚Üí worst fit
- ‚úÖ Explain why Candidate A outranks Candidate B
- ‚úÖ Identify:
  - Strongest overall candidate
  - Best skill coverage
  - Biggest gaps per candidate
- ‚úÖ Recommend roles per candidate (relative to group)

---

## üìã Output Contract (STRICT)

Backend returns:
```json
{
  "batch_id": "batch_1234567890",
  "job_requirements": "Senior Engineer...",
  "documents": [
    {
      "document_id": "doc_batch_...",
      "filename": "resume1.pdf",
      "status": "success",
      "analysis": {
        "llm_analysis": {
          "candidate_name": "John Doe",
          "experience_summary": "10 years in full-stack development",
          "skills": {
            "technical": ["Python", "React", "AWS"],
            "soft": ["Leadership", "Communication"]
          },
          "overall_score": 82,
          "preliminary_fit_score": 82,
          "recommended_roles": ["Senior Engineer", "Tech Lead", "Architect"]
        }
      }
    }
  ],
  "comparative_analysis": {
    "comparative_ranking": [
      {
        "document_id": "doc_batch_..._1",
        "rank": 1,
        "normalized_fit_score": 85,
        "rationale": "Strongest in Python and AWS, best fit for role"
      },
      {
        "document_id": "doc_batch_..._2",
        "rank": 2,
        "normalized_fit_score": 72,
        "rationale": "Good React skills but missing AWS experience"
      }
    ],
    "strengths_comparison": "Candidate 1 excels in cloud infrastructure (AWS, GCP). Candidate 2 stronger in frontend (React, Vue). Compare their expertise areas...",
    "weaknesses_comparison": "Candidate 1 lacks frontend specialization. Candidate 2 has no cloud platform experience...",
    "skill_coverage_matrix": {
      "doc_batch_..._1": {
        "covered": ["Python", "AWS", "Docker"],
        "missing": ["Machine Learning", "DevOps"]
      },
      "doc_batch_..._2": {
        "covered": ["React", "TypeScript", "PostgreSQL"],
        "missing": ["Cloud platforms", "System design"]
      }
    },
    "strongest_candidate": {
      "document_id": "doc_batch_..._1",
      "reason": "Highest overall fit: strongest AWS skills, leadership experience, and proven system design capabilities"
    },
    "best_skill_coverage": {
      "document_id": "doc_batch_..._1",
      "skills": ["Python", "AWS", "Docker", "Leadership"],
      "reason": "Covers most required skills for Senior Engineer role"
    },
    "hiring_recommendations": {
      "doc_batch_..._1": "STRONG RECOMMEND: Best overall fit for Senior Engineer role. Ready for immediate hire.",
      "doc_batch_..._2": "GOOD FIT: Recommend for Mid-level Frontend Engineer or with upskilling in cloud platforms."
    },
    "executive_summary": "Candidate 1 is the clear winner with comprehensive cloud and backend expertise. Candidate 2 offers strong frontend skills but would require upskilling in infrastructure for the Senior Engineer role."
  },
  "success_count": 2,
  "failed_count": 0,
  "processing_time": 145.32,
  "success": true
}
```

---

## ü§ñ LLM Prompt Enforcement

**CRITICAL for Qwen2.5:**

1. **Single LLM Call:** All candidates in ONE prompt (PASS 2)
2. **Explicit Instruction:** 
   ```
   "You are comparing candidates against each other. Do not evaluate them independently."
   ```
3. **Reference by ID:** Must reference candidates by document_id (DOC_X)
4. **Comparative Language:** Must explain rankings with specific details
5. **Quality Checks:**
   - ‚úÖ Scores vary across candidates (not identical)
   - ‚úÖ Rankings reference different candidates
   - ‚úÖ Summaries use comparative language (vs, stronger, weaker, better, worse)

---

## üé® Frontend Display

### PASS 1: Per-Candidate Panels
- Candidate name
- Experience summary
- Skills (technical + soft)
- AI Executive Assessment
- Preliminary fit score (0-100)
- Recommended roles

### PASS 2: Comparative View
- **Final Ranking Table:**
  - Rank #1-N
  - Candidate name
  - Normalized fit score (color-coded)
  - Rationale for ranking

- **Top Candidate Card:**
  - Name
  - Why they rank #1

- **Strengths Comparison:**
  - Which candidate excels where
  - Specific skill advantages
  - Leadership vs technical comparison

- **Weaknesses Comparison:**
  - Gaps per candidate
  - Experience deficits
  - Skill mismatches

- **Skill Coverage Matrix:**
  - Covered skills per candidate
  - Missing skills per candidate
  - Job requirements alignment

- **Tailored Hiring Recommendations:**
  - Different recommendation per candidate
  - Role suggestions relative to group
  - Upskilling opportunities

### Sorting Options:
- ‚úÖ Sort by fit score (best ‚Üí worst)
- ‚úÖ Sort by name (A-Z)
- ‚úÖ Sort by skills matched
- ‚úÖ Sort by experience level

---

## ‚ùå Failure Criteria (Must NOT Occur)

1. **Identical Summaries:** If all candidates get the same description ‚Üí FAIL
   - **Fix:** LLM enforces comparative language and different perspectives per candidate

2. **Identical Scores:** If all candidates score similarly ‚Üí FAIL
   - **Fix:** LLM normalizes scores to show relative ranking within batch

3. **Missing Comparisons:** If response doesn't reference other candidates ‚Üí FAIL
   - **Fix:** LLM prompt explicitly enforces comparative evaluation

4. **No Differentiation:** If recommendations are generic/identical ‚Üí FAIL
   - **Fix:** LLM generates role-specific recommendations per candidate

---

## üèóÔ∏è Architecture

### Backend Flow:
```
PASS 1 (Parallel-Ready):
‚îú‚îÄ Document 1: PDF ‚Üí Extract ‚Üí NLP ‚Üí Reconstruct ‚Üí LLM (Single)
‚îú‚îÄ Document 2: PDF ‚Üí Extract ‚Üí NLP ‚Üí Reconstruct ‚Üí LLM (Single)
‚îî‚îÄ Document 3: PDF ‚Üí Extract ‚Üí NLP ‚Üí Reconstruct ‚Üí LLM (Single)
         ‚Üì
PASS 2 (Single LLM Call with ALL):
‚îî‚îÄ LLM(all_candidates, job_requirements) ‚Üí Comparative Analysis
```

### Key Methods:

**backend/pipeline/llm_analyzer.py:**
- `analyze()` - PASS 1 (per-candidate analysis)
- `analyze_comparative()` - PASS 2 (cross-candidate comparative)
- `_build_comparative_prompt()` - Enforces comparative evaluation
- `_parse_comparative_response()` - Extracts ranking and explanations
- `_verify_comparative_quality()` - Checks for failure criteria

**backend/main.py:**
- `/batch-analyze` endpoint - Orchestrates PASS 1 + PASS 2
- Calls `llm_analyzer.analyze()` for each document
- After all PASS 1 complete, calls `llm_analyzer.analyze_comparative()`
- Returns combined result

**frontend/js/main.js:**
- `renderBatchResults()` - Displays both PASS 1 and PASS 2
- `renderComparisonView()` - PASS 1 individual candidate table
- `renderComparativeAnalysis()` - PASS 2 comparative ranking table
- `sortBatchResults()` - Sort by score, name, skills, experience

---

## üìä Example Scenario

**Input:** 3 resumes (Senior Engineer role, specific job requirements)

**PASS 1 Output:**
```
Candidate 1: Preliminary Score 82/100
  - 10 years experience
  - Strong in Python, AWS, Docker
  - Leadership background

Candidate 2: Preliminary Score 78/100
  - 8 years experience
  - Strong in React, TypeScript, PostgreSQL
  - No cloud experience

Candidate 3: Preliminary Score 65/100
  - 5 years experience
  - Full-stack but junior level
  - Limited enterprise experience
```

**PASS 2 Output (Comparative):**
```
NORMALIZED RANKING:
1. Candidate 1 (Score: 88) - Best AWS/backend fit, leadership ready
2. Candidate 2 (Score: 72) - Strong frontend, needs infrastructure upskilling
3. Candidate 3 (Score: 58) - Needs experience for senior role

WHY: Candidate 1 has AWS expertise which is required. Candidate 2 is strong 
but lacks cloud experience. Candidate 3 needs 2-3 more years.

RECOMMENDATION:
- Candidate 1: HIRE immediately for Senior Engineer
- Candidate 2: HIRE for Mid-level, mentor in cloud
- Candidate 3: HIRE as Junior with growth plan
```

---

## ‚úÖ Testing

### Manual Testing:
1. Upload 2-3 sample resumes with same job requirements
2. Wait for PASS 1 + PASS 2 to complete
3. Verify:
   - Different scores per candidate
   - Explanations reference other candidates
   - Ranking makes sense relative to job requirements
   - Recommendations are tailored per candidate

### Automated Testing:
```bash
python test_batch_analysis.py
```

---

## üöÄ Ready for Production

The two-pass system is fully implemented:
- ‚úÖ Backend PASS 1 + PASS 2 complete
- ‚úÖ LLM prompts enforce comparative evaluation
- ‚úÖ Quality checks verify true comparative analysis
- ‚úÖ Frontend displays both PASS 1 and PASS 2 results
- ‚úÖ Sorting and filtering implemented
- ‚úÖ Error handling robust

**Key Achievement:** True comparative system, NOT repeated single-candidate analysis.

